#!/bin/bash
#====================================================
#	SCRIPT: INFINITENET PLUS MANAGER
#   DATA ATT:   28 de Set 2020
#	DESENVOLVIDO POR:	ALVES_S.A
#	CONTATO TELEGRAM:	http://t.me/alves_s.a
#	CANAL TELEGRAM:	http://t.me/sshplus
#====================================================

# Verifica se está sendo executado como root
if [[ "$(whoami)" != "root" ]]; then
  echo -e "\033[1;31mErro: Este script deve ser executado como root!\033[0m"
  exit 1
fi

# Atualiza informações de IP e timezone
_lvk=$(wget -qO- https://raw.githubusercontent.com/InfiniteNet/IFNT-PLUS-MANAGER/master/Install/versao)
IP=$(wget -qO- sshplus.xyz/meuip.php)
IP2=$(wget -qO- http://whatismyip.akamai.com/)
[[ "$IP" != "$IP2" ]] && ipdovps="$IP2" || ipdovps="$IP"
echo -e "$ipdovps" >/etc/IP

lst=$1 && lst1=$2 && lst2=$3 && key1=$4 && key2=crz

# Configura fuso horário
echo -e "America/Sao_Paulo" >/etc/timezone
ln -fs /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime >/dev/null 2>&1
dpkg-reconfigure --frontend noninteractive tzdata >/dev/null 2>&1

# Verifica se argumento lst1 está vazio
[[ -z $lst1 ]] && {
  rm -rf $_Ink/list >/dev/null 2>&1
  cat /dev/null >~/.bash_history
  history -c
  exit 0
}

# Criação de diretórios necessários
mkdir -p /etc/SSHPlus/senha /etc/SSHPlus/userteste /etc/SSHPlus/.tmp /etc/bot/{info-users,arquivos,revenda,suspensos}
touch /etc/SSHPlus/Exp /etc/bot/lista_ativos /etc/bot/lista_suspensos

# Atualização de licença
echo -e 'by: @ALVES_S.A' >/usr/lib/sshplus
cat /usr/lib/sshplus > $lst2/licence
cat /usr/lib/sshplus > /etc/SSHPlus/.tmp/crazy

# Verifica e ajusta configurações do Apache e SSH
if netstat -nplt | grep -w 'apache2' | grep -w '80'; then
  sed -i "s/Listen 80/Listen 81/g" /etc/apache2/ports.conf
  systemctl restart apache2
fi

if [[ "$(grep -o '#Port 22' /etc/ssh/sshd_config)" == "#Port 22" ]]; then
  sed -i "s;#Port 22;Port 22;" /etc/ssh/sshd_config
  systemctl restart ssh
fi

# Ajusta configurações SSH
grep -v "^PasswordAuthentication" /etc/ssh/sshd_config > /tmp/passlogin && mv /tmp/passlogin /etc/ssh/sshd_config
echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config

# Limpeza e download de módulos
_dir1='/bin'
_dir2='/etc/SSHPlus'
rm -f $_dir2/{ShellBot.sh,cabecalho,open.py,proxy.py,wsproxy.py}

_mdls=("addhost" "delhost" "alterarsenha" "criarusuario" "expcleaner" "mudardata" "remover" "criarteste" "verifbot" "droplimiter" 
       "alterarlimite" "ajuda" "sshmonitor" "badvpn" "userbackup" "instsqd" "blockt" "otimizar" "menu" "speedtest" 
       "banner" "senharoot" "reiniciarservicos" "reiniciarsistema" "attscript" "conexao" "delscript" "detalhes" 
       "botssh" "infousers" "slow_dns" "verifatt" "limiter" "uexpired" "cabecalho" "bot" "open.py" "proxy.py" "wsproxy.py")

for _arq in ${_mdls[@]}; do
  wget -c -P $_dir1 https://raw.githubusercontent.com/InfiniteNet/IFNT-PLUS-MANAGER/master/Modulos/$_arq
  chmod +x $_dir1/$_arq
done

# Mover arquivos para o diretório correto
mv $_dir1/{cabecalho,bot,open.py,proxy.py,wsproxy.py} $_dir2

# Configuração de hosts
_arq_host="/etc/hosts"
_host=("d1n212ccp6ldpw.cloudfront.net" "dns.whatsapp.net" "portalrecarga.vivo.com.br/recarga" 
       "navegue.vivo.com.br/controle/" "navegue.vivo.com.br/pre/" "www.whatsapp.net" "/SSHPLUS?")

for host in ${_host[@]}; do
  if ! grep -wq "$host" $_arq_host; then
    echo "127.0.0.1 $host" >> $_arq_host
  fi
done

# Criação de script de autostart
if [[ ! -e /etc/autostart ]]; then
  echo '#!/bin/bash
clear
#INICIO AUTOMATICO' > /etc/autostart
  chmod +x /etc/autostart
else
  [[ $(ps x | grep "bot_plus" | grep -v grep | wc -l) != '0' ]] && wget -qO- https://raw.githubusercontent.com/shellscriptx/shellbot/master/ShellBot.sh > /etc/SSHPlus/ShellBot.sh
  for proc in $(ps x | grep 'dmS' | grep -v 'grep' | awk {'print $1'}); do
    screen -r -S "$proc" -X quit
  done
  screen -wipe >/dev/null
fi

# Configuração de crontab
crontab -r
(
  crontab -l 2>/dev/null
  echo "@daily /bin/verifatt"
  echo "@reboot /etc/autostart"
  echo "* * * * * /etc/autostart"
  echo "0 */6 * * * /bin/uexpired"
) | crontab -

# Baixa e configura jq
wget https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 -O /usr/bin/jq
chmod +x /usr/bin/jq

# Reinicia serviços
systemctl restart cron
systemctl restart ssh
[[ -d /var/www/html/openvpn ]] && systemctl restart apache2

# Limpeza de arquivos temporários
rm -rf $lst1/list
